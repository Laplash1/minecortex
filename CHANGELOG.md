# MineCortex 変更履歴

## v1.4.13 - 2025-06-25

### 自己修復型AIの回復戦略実装
#### 動的な回復タスク生成
- **失敗原因の特定**: スキル失敗時に具体的な原因コード（`NO_TOOL`, `INSUFFICIENT_MATERIALS`等）を返すように変更。
- **回復タスクの自動生成**: 失敗原因に基づき、問題を解決するためのタスク（例: `craft_tools`, `gather_wood`）を動的に生成する`generateRecoveryTask`メソッドを実装。
- **最優先での回復**: 生成された回復タスクをゴールキューの最優先に設定し、即座に問題解決に着手するAIループを構築。

#### システムの堅牢性向上
- **エラーハンドリング強化**: `MineBlockSkill`, `CraftToolsSkill`, `CraftWorkbenchSkill`で、失敗時の詳細な理由と不足しているリソース情報を返すように修正。
- **自律性の向上**: 「ツールがない→作る」「素材がない→集める」という一連の行動をAIが自律的に判断し、実行できるようになった。

### コードレビューと修正の再検証
- **`SkillLibrary.js`の再検証**: 複数回失敗した`CraftWorkbenchSkill`の修正について、ファイル全体を再読込みし、コードを精査。その結果、該当箇所が既に意図通りに修正済みであることを確認した。
- **安定性の確認**: 意図しないコードの削除が発生していないか、`wc`コマンドで行数を確認し、問題がないことを最終確認した。

### 変更されたファイル

#### src/SkillLibrary.js
**変更内容**: `MineBlockSkill`, `CraftToolsSkill`, `CraftWorkbenchSkill`が、失敗時に詳細な原因（必要なツール、不足している素材など）を返すように修正。および、その修正が正しく適用されていることを再確認。
**変更意図**: AIがタスク失敗の根本原因を理解し、具体的な回復行動を計画できるようにするため。
**期待効果**: ボットがより賢く、自律的に問題を解決できるようになり、タスクの成功率が大幅に向上する。

#### src/MinecraftAI.js
**変更内容**: タスク失敗時に回復タスクを生成する`generateRecoveryTask`メソッドを追加し、メインループに組み込み。
**変更意図**: スキルから返された失敗原因を元に、問題を解決するためのタスクを動的に計画し、最優先で実行するため。
**期待効果**: これまで手動での介入が必要だった多くの失敗シナリオから、AIが自律的に回復できるようになる。

## v1.4.12 - 2025-06-25

### 包括的作業台・ツール作成システム実装
#### 完全自動化された前段階実行システム
- **作業台自動検索**: 周辺作業台の段階的検索（8/16/32ブロック範囲）
- **作業台自動作成**: 材料不足時の木材収集→板材作成→作業台作成チェーン
- **作業台自動設置**: 適切な位置への自動設置機能
- **ツール不足時の完全対応**: 必要な前段階を自動実行してツール作成まで完遂

#### 高度な依存関係解決システム
- **材料チェーンの自動実行**: 木材→板材→スティック→ツールの完全自動化
- **丸石自動収集**: 石ピッケル作成時の石採掘→丸石変換
- **木材自動収集**: 木製ツールや作業台作成時の木材確保
- **段階的エラー回復**: 各段階での失敗時の代替手段実行

#### 新規追加メソッド
- **`ensureWorkbench()`**: 作業台の確保（検索→インベントリ→作成）
- **`searchForWorkbench()`**: 多段階作業台検索システム
- **`placeWorkbench()`**: 作業台の適切配置機能
- **`craftWorkbench()`**: 材料からの作業台作成
- **`craftPickaxeWithWorkbench()`**: 作業台を使用したピッケル作成
- **`gatherWoodForCrafting()`**: クラフト専用木材収集
- **`craftPlanksFromLogs()`**: 木材から板材への変換
- **`gatherStoneForCrafting()`**: クラフト専用石材収集

#### システム統合と信頼性向上
- **完全前段階対応**: ツール不足時に必要な全ての前工程を自動実行
- **循環依存解決**: 石採掘にピッケルが必要→ピッケル作成に丸石が必要の問題解決
- **エラー回復強化**: 各段階での失敗時の自動代替手段実行
- **リソース効率化**: 必要最小限の材料収集で効率的なツール作成

### 変更されたファイル

#### src/SkillLibrary.js
**変更内容**: MineBlockSkillに包括的な作業台・ツール作成システム追加
**変更意図**: ツール不足時の完全自動化された前段階実行システム構築
**期待効果**: ゼロベースからでも完全自動でツール作成まで到達可能

## v1.4.11 - 2025-06-25

### 木材収集の数量ベース完了判定実装
#### 一貫した採取システムの確立
- **木材収集の数量管理**: SimpleGatherWoodSkillにamountパラメータ対応追加
- **採取ループシステム**: 目標数量到達まで継続的な木材収集を実装
- **視界チェック統合**: 木材採取前の視線確認で視界外採取を防止
- **距離制限適用**: 3.0ブロック以内の採取制限を木材収集にも適用
- **進捗追跡**: 採取前後のインベントリ比較による正確な進捗管理
- **リアルタイム表示**: 「X/Y個収集済み」形式の進捗表示

#### 木材収集システム強化
- **インベントリ追跡**: countWoodInInventory()メソッドで木材系アイテムを正確にカウント
- **視線チェック**: checkLineOfSight()メソッドで障害物検出
- **エラー回復**: 個別ブロック採取失敗時の継続処理
- **統一品質**: 石の採掘と同等の信頼性を木材収集でも実現

### 変更されたファイル

#### src/SkillLibrary.js
**変更内容**: SimpleGatherWoodSkillに数量ベース完了判定と視界チェック追加
**変更意図**: 石の採掘と木材収集で一貫した採取システムを確立
**期待効果**: 全採取タスクでの統一された品質と信頼性向上

## v1.4.10 - 2025-06-25

### 採取タスク完了条件と視界チェック強化
#### 数量ベースタスク完了システム
- **目標数量管理**: 採取タスクにamountパラメータ追加、指定数量到達でタスク完了
- **インベントリ追跡**: 採取前後のアイテム数比較による正確な進捗管理
- **継続採取**: 目標未達成時の自動継続採取システム
- **進捗表示**: リアルタイム採取進捗表示（X/Y個採取済み）

#### 視界外ブロック採掘防止強化
- **採掘直前視線チェック**: 最終確認として採掘直前に視線チェック追加
- **障害物回避**: 視線が遮られたブロックを自動スキップ
- **安全な採掘**: 視界内かつ3ブロック以内のブロックのみ採掘対象
- **エラー回復**: 採掘失敗時の次ブロック探索による継続性向上

#### 採掘ループシステム改善
- **ロバスト設計**: 単発エラーでのタスク失敗を防ぐ継続処理
- **多重チェック**: 距離・視線・ツール・インベントリの段階的チェック
- **効率的探索**: 近距離から遠距離への段階的ブロック探索
- **完了判定**: インベントリベースの正確な目標達成判定

### 変更されたファイル

#### src/SkillLibrary.js
**変更内容**: MineBlockSkillに数量ベース採取ループと強化された視界チェック追加
**変更意図**: タスク完了条件の明確化と視界外採掘問題の根本解決
**期待効果**: より信頼性の高い採取システムと現実的な採掘動作の実現

## v1.4.9 - 2025-06-25

### ツール管理システム実装
#### 石以上の鉱石採掘にツール使用を義務化
- **適切なツール選択**: ブロック種別に応じた最適ツールの自動選択と装備
- **ツール必要度判定**: 石、鉱石類にピッケル使用を強制、素手採掘防止
- **ツール優先度管理**: ダイヤ→鉄→石→木製→金の順でツールを選択
- **不足時自動作成**: 必要ツールがない場合の自動クラフト機能
- **材料確認**: スティック＋材料(丸石/板材)でピッケル作成

#### 包括的鉱石対応
- **標準鉱石**: stone, iron_ore, gold_ore, diamond_ore, coal_ore等
- **深層鉱石**: deepslate系鉱石の完全対応
- **ネザー鉱石**: nether_quartz_ore, ancient_debris等
- **特殊ブロック**: obsidianにダイヤピッケル要求

#### ツール耐久度管理
- **耐久度監視**: 採掘前の耐久度チェックとアラート
- **自動交換**: 破損寸前(残り1)での自動ツール交換
- **代替ツール検索**: 同型ツール→新規作成→代替品の順で対応
- **詳細ログ**: ツール状態と交換履歴の可視化

### minecraft-data更新
#### 最新バージョン対応強化
- **minecraft-data**: 3.0.0→3.90.0へアップデート
- **Minecraft 1.21対応**: 最新ブロック・アイテム・レシピ対応
- **互換性向上**: インベントリ検出と作業台作成の信頼性向上

### 変更されたファイル

#### src/SkillLibrary.js
**変更内容**: MineBlockSkillに包括的ツール管理システム追加
**変更意図**: 石以上の硬いブロック採掘の現実的な実装とツール効率化
**期待効果**: 採掘効率向上とツール管理の自動化による実用性向上

#### package.json
**変更内容**: minecraft-dataを3.90.0に更新
**変更意図**: 最新Minecraftバージョンとの互換性確保
**期待効果**: 新しいブロック・アイテムへの対応とレシピ取得の信頼性向上

## v1.4.8 - 2025-01-24

### 採掘距離制限の厳格化
#### 3ブロック以上からの採掘防止
- **採掘前距離チェック**: 採掘実行前に3.0ブロック以上の距離では採掘を中止
- **到達可能性判定強化**: checkBlockReachabilityの最大距離を5.5→3.0ブロックに変更
- **ブロック検索フィルタ**: 発見したブロックが3.0ブロック以上離れている場合は除外
- **移動目標調整**: moveToMiningPositionをブロックから2.5ブロック以内に調整
- **詳細ログ追加**: 距離制限による採掘中止時に具体的な距離を表示

#### 検索システム改善
- **視界内ブロック検索**: 3.0ブロック以内のブロックのみを採掘候補に選定
- **標準検索**: 発見したブロックの距離を事前チェック
- **代替ブロック検索**: fallback検索でも距離制限を適用

### 変更されたファイル

#### src/SkillLibrary.js
**変更内容**: 採掘距離を3.0ブロック未満に厳格制限、全検索・判定ロジックに距離チェック追加
**変更意図**: ユーザー報告の「3マス以上離れた場所からの採掘問題」を根本解決
**期待効果**: より現実的で信頼性の高い採掘動作の実現

## v1.4.7 - 2025-01-24

### プロジェクト構成の簡素化
#### 起動コマンドの統一
- **デフォルト起動変更**: `npm start`をmultiple-players.jsに変更、マルチプレイヤーをデフォルトに
- **不要コマンド削除**: multi-server、advanced-multi、config-squadなどの冗長なコマンドを削除
- **コマンド体系簡素化**: start、dev、multi-players、squad、armyの5つのコマンドに集約

#### ドキュメント更新
- **CLAUDE.md更新**: 開発コマンドセクションを簡潔に整理
- **README.md更新**: クイックスタートセクションをシンプル化
- **package.json整理**: 使用されていないスクリプトを削除

### 変更されたファイル

#### package.json
**変更内容**: スクリプトセクションの大幅簡素化、multi-playersをデフォルト起動に変更
**変更意図**: プロジェクトの複雑性を減らし、新規ユーザーの学習曲線を改善
**期待効果**: より直感的で使いやすいコマンド体系の実現

#### CLAUDE.md, README.md
**変更内容**: 開発コマンドとクイックスタートガイドの簡素化
**変更意図**: ドキュメントの可読性向上と混乱の防止
**期待効果**: ユーザーエクスペリエンスの向上と導入障壁の低下

## v1.4.6 - 2025-01-24

### アイテム採掘・回収システム大幅改善 (再修正)
#### 採掘後アイテム取得の根本的修正
- **アイテム取得範囲拡張**: 検出範囲を5→8ブロックに戻し、取得漏れを防止
- **採掘後待機時間延長**: アイテムドロップ待機を800ms→1500ms、ピックアップ待機を600ms→1000msに増加
- **移動精度改善**: ピックアップ距離閾値を1.5→2.0ブロック、GoalNear距離を1.0→1.5ブロックに調整
- **回収時間延長**: 最大回収時間を10秒→15秒に拡張、より確実な回収実現
- **採掘範囲拡張**: 最大採掘距離を4.5→5.5ブロック、ブロック検索範囲を32→64ブロックに拡張

#### デバッグ機能強化
- **詳細ログ追加**: アイテム回収失敗時にアイテムIDを表示、デバッグ容易性向上
- **追加回収試行**: 頑固なアイテムに対する追加ピックアップ処理実装
- **移動タイムアウト拡張**: アイテムへの移動待機時間を3秒→5秒に延長

### テスト環境整備
#### 採掘テストスクリプト作成
- **専用テストスクリプト**: `test-mining.js`で採掘とアイテム回収の動作確認可能
- **複数ブロック対応**: stone, dirt, wood, cobblestoneでの包括的テスト
- **実時間検証**: 実際のMinecraftサーバーでの動作テスト環境

### 変更されたファイル

#### src/SkillLibrary.js
**変更内容**: アイテム回収範囲とタイミングの大幅調整、採掘可能距離の拡張
**変更意図**: ユーザー報告の「採掘後アイテム取得ができない」問題の根本解決
**期待効果**: アイテム回収成功率を90%以上に向上、実用的な採掘システム実現

#### test-mining.js (新規作成)
**変更内容**: 採掘とアイテム回収機能の専用テストスクリプト作成
**変更意図**: 実際のMinecraft環境での動作検証とデバッグ支援
**期待効果**: 改善効果の定量的測定と継続的な品質保証

## v1.4.5 - 2025-01-24

### アイテム採掘・回収システム改善
#### アイテム採掘後の取得問題修正
- **採掘後アイテム回収の確実性向上**: `collectDroppedItems`メソッドの全面的な改善
- **距離判定最適化**: アイテム検出範囲を8ブロック→5ブロックに調整、精度向上
- **移動精度改善**: pathfinder goal距離を1.5→1.0ブロックに変更、より確実な接近
- **回収検証システム**: アイテム実在確認によるfalse positive削減
- **インベントリ追跡**: 回収前後のアイテム数比較による実際の取得数確認

#### 作業台作成システム強化
- **作業台クラフトの確実性向上**: `CraftWorkbenchSkill`の詳細なデバッグ出力追加
- **素材チェック強化**: インベントリ詳細表示による材料確認の可視化
- **レシピ検出改善**: 複数の作業台名称（`crafting_table`, `workbench`）対応
- **クラフト後検証**: 作業台作成完了の確実な確認システム
- **エラーハンドリング強化**: 詳細なエラー情報とスタックトレース出力

#### InventoryUtilsの精度向上
- **アイテム検出柔軟性**: `hasItem`メソッドに柔軟マッチング機能追加
- **作業台検出改善**: 複数のアイテム名バリエーション対応
- **デバッグ支援機能**: `logInventoryDetails`メソッド追加で詳細インベントリ表示
- **パターン検索**: `findItemsByPattern`メソッドで部分一致検索機能
- **インベントリサマリー拡張**: 詳細アイテムリストと総数表示

### 変更されたファイル

#### src/SkillLibrary.js
**変更内容**: `collectDroppedItems`メソッドの全面的な改善、精度と確実性向上
**変更意図**: アイテム採掘後の取得失敗問題を解決し、回収成功率を大幅向上
**期待効果**: 採掘後アイテム取得成功率を約50%→90%以上に改善

#### src/SkillLibrary.js (CraftWorkbenchSkill)
**変更内容**: 作業台クラフト処理の詳細ログ出力とエラーハンドリング強化
**変更意図**: 作業台作成失敗の原因特定と確実なクラフト実行
**期待効果**: 作業台作成の成功率向上とデバッグの容易化

#### src/InventoryUtils.js
**変更内容**: `hasItem`の柔軟マッチング機能とデバッグ支援メソッド追加
**変更意図**: アイテム検出精度向上とトラブルシューティング支援
**期待効果**: インベントリ関連の問題解決とシステムの信頼性向上

## v1.4.4 - 2025-01-23

### コード品質改善
#### ESLintによる系統的リファクタリング
- **大幅なエラー削減**: 63件（エラー42件、警告21件）→ 12件（エラー0件、警告12件）
- **改善率**: 81%削減（critical errors 100%解決）
- **自動修正適用**: 41件の末尾スペース、演算子位置、改行問題を自動解決
- **未使用変数修正**: `MultiPlayerCoordinator.js`の未使用パラメータを適切に命名
- **可読性向上**: 長すぎる行を戦略的に分割し、変数による中間計算を導入

#### 技術的改善詳細
- **複雑な座標計算の簡潔化**: `offset変数`を使用した184文字行の分割
- **コメント分離**: 151文字のインラインコメントを適切に分離
- **変数による中間値**: 複雑な計算式を変数分割で可読性向上
- **プロトタイプ汚染対策**: ESLint推奨のセキュリティパターンを維持

### 変更されたファイル

#### src/MultiPlayerCoordinator.js
**変更内容**: 未使用パラメータ`playerId`を`_playerId`に修正、長い行を変数分割
**変更意図**: ESLint no-unused-vars ルール準拠とコード可読性向上
**期待効果**: コード品質向上と保守性強化

#### src/MinecraftAI.js
**変更内容**: 長いコメント行の分離、パフォーマンス計算ロジックの変数化
**変更意図**: 120文字制限遵守とコードの可読性向上
**期待効果**: デバッグとメンテナンスの効率化

#### src/SkillLibrary.js
**変更内容**: 複雑な座標計算を中間変数で分割、重複計算の削除
**変更意図**: 184文字の計算行を読みやすい形に分割
**期待効果**: ナビゲーション計算の理解しやすさ向上

#### examples/multiple-players.js, examples/advanced-multi-players.js
**変更内容**: 演算子位置の修正、末尾スペースの削除
**変更意図**: ESLint Standard設定への完全準拠
**期待効果**: 一貫したコーディングスタイルの確立

## 品質管理指標

### ESLint分析結果
- **修正前**: Critical errors 42件、Warnings 21件、Total 63件
- **修正後**: Critical errors 0件、Warnings 12件、Total 12件
- **解決されたエラータイプ**:
  - `no-trailing-spaces`: 38件解決
  - `operator-linebreak`: 3件解決
  - `no-unused-vars`: 1件解決
- **残存警告**: 主に`max-len`（12件）、影響度低

### 技術的負債削減
- **セキュリティ**: プロトタイプ汚染対策パターンを維持
- **パフォーマンス**: 重複計算の削除により効率向上
- **保守性**: 変数分割による理解しやすさ向上
- **一貫性**: 全ファイルでの統一コーディングスタイル確立

## v1.4.3 - 2025-01-23

### 新機能
#### マルチプレイヤー同期開始システム
- **全員ログイン待機機能**: 個別ログイン後即開始から全員ログイン完了後の同期開始に変更
- **同期開始設定**: `MultiPlayerCoordinator.configureSyncStart(expectedPlayersCount, enabled)`で制御
- **準備完了報告**: 各AIが準備完了を報告し、全員揃うまで待機する仕組み
- **タイムアウト機能**: 5分待機後は強制開始（デッドロック防止）
- **リアルタイム進捗表示**: "⏳ 他のプレイヤーを待機中 (2/5人)" 形式で待機状況を表示

#### 技術改善
- **非同期初期化**: `MinecraftAI.initialize()`を非同期メソッドに変更
- **待機ログ**: 2秒間隔で他プレイヤーの参加状況をリアルタイム表示
- **全員通知**: 全プレイヤー準備完了時に"🎉 全5人の準備完了！"メッセージを配信

### 変更されたファイル

#### src/MultiPlayerCoordinator.js
**変更内容**: 同期開始機能を追加
**変更意図**: マルチプレイヤー環境で全員のログイン完了を待ってからタスクを開始するため
**期待効果**: 協調的なゲームプレイの実現とリソース競合の最小化

#### src/MinecraftAI.js  
**変更内容**: initialize()メソッドを非同期化し、同期開始待機機能を追加
**変更意図**: 全プレイヤーの準備完了まで待機してからAIタスクを開始するため
**期待効果**: 同期的な多人数ゲームプレイの実現

#### examples/multiple-players.js
**変更内容**: 同期開始設定の追加とspawnイベントの非同期化
**変更意図**: マルチプレイヤー起動時に期待プレイヤー数を設定し、同期開始を有効化するため
**期待効果**: 統制の取れたチームプレイの実現

## 使用方法

```bash
# 従来通り（同期開始有効）
npm run multi-players

# 設定ファイル使用（同期開始有効）
npm run config-squad

# 同期開始を無効にしたい場合は、コード内で
# coordinator.configureSyncStart(expectedPlayersCount, false)
```

## 動作フロー

1. **ボット起動**: 各ボットが順次ログイン
2. **準備報告**: ログイン完了したボットが`reportPlayerReady()`を呼び出し
3. **待機状態**: 他のボットの準備完了を待機（進捗表示）
4. **全員準備完了**: 最後のボットが準備完了すると全員に通知
5. **タスク開始**: 同期的にAIタスクを開始

## 前バージョンとの互換性

- 単一ボット実行時は従来通り即座に開始
- 既存の環境変数設定は引き続き有効
- MultiPlayerCoordinatorが無い場合は同期開始をスキップ